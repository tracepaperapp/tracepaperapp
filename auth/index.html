<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signing in</title>
  <script src="/js/config/configuration.js"></script>
</head>
<body>

<script>
  function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
  }
  setTimeout(function(){
      if (location.hash.toLowerCase().indexOf("id_token=") === -1){
        location = `${localStorage["aws-congnito-ui"]}/oauth2/authorize?client_id=${localStorage["aws-congnito-app-id"]}&response_type=token&scope=openid&redirect_uri=${window.location.href.slice(0,-1)}`;
      }
      const token = location.hash.split("#").at(-1)
                        .split("&").filter(x => x.startsWith("id_token=")).at(0)
                        .replace("id_token=","");
      const expires_in = location.hash.split("#").at(-1)
                            .split("&").filter(x => x.startsWith("expires_in=")).at(0)
                            .replace("expires_in=","");
      sessionStorage["token"] = token;
      sessionStorage["token_expiration"] = Date.now() + (parseInt(expires_in) * 1000);
      let payload = parseJwt(token);
      sessionStorage["username"] = payload["cognito:username"];
      sessionStorage["email"] = payload["email"];
      location.href = "../"
  },1);
</script>
</body>
</html>