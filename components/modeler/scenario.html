<template x-component="scenario">
    <div navigation-type="scenario"
         id="active-tab"
         x-show="navigationElementActive"
         x-cloak
         x-transition>
        <div :file="navigation" x-data="scenarioModel">
            <div class="grid grid-cols-12 gap-3 mt-5">
                <div class="col-span-8">

                    <h3 class="text-2xl font-semibold text-gray-800 mb-5">
                        Scenario: <span x-text="path"></span>
                    </h3>
                    <div class="grid grid-cols-12 gap-3 mt-5">
                        <div class="col-span-3 scrollbar-v scrollbar-v-left border-r pr-2 h-[70vh]">
                            <ul class="menu menu-xs rounded-lg scroll-v-inside scrollbar-h mb-5">
                                <template x-for="(activity,index) in model.activity" :key="activity.att_id">
                                    <li x-data="scenarioActivity">
                                        <a @click="scrollToTable(activity.att_id)"
                                           :class="active == activity.att_id ? 'active' : ''">
                                            <i class="fa-solid fa-play"></i>
                                            <p>
                                                <span x-text="type"></span><br>
                                                <span x-text="activity.att_description"></span>
                                            </p>
                                        </a>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <div class="col-span-9 scrollbar-v h-[70vh]" @scroll="onScroll">
                            <button x-show="model.activity.length == 0" x-cloak x-transition
                                    @click="prepare_insert_before"
                                    class="btn btn-block btn-outline btn-primary">Add first activity</button>
                            <dialog x-show="insertActivityModal" x-cloak x-transition
                                    class="modal modal-open">
                                <div class="modal-box">
                                    <form method="dialog">
                                        <button @click="insertActivityModal = false" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                                    </form>
                                    <h3 class="font-bold text-lg">Add activity</h3>
                                    <ul class="menu bg-base-200 rounded-box w-full">
                                        <li><a @click="insert('set-variables')">Set variables</a></li>
                                        <li><a @click="insert('mutation')">Trigger command</a></li>
                                        <li><a @click="insert('query')">Query view store</a></li>
                                        <li><a @click="insert('switch-user')">Switch user</a></li>
                                        <li><a @click="insert('grant-role')">Grant role to current user</a></li>
                                        <li><a @click="insert('refresh-token')">Refresh curent user token</a></li>
                                        <li><a @click="insert('wait')">Sleep</a></li>
                                    </ul>
                                </div>
                            </dialog>
                            <div x-init="onScroll">
                                <template x-for="(activity,index) in model.activity" :key="activity.att_id">
                                    <table class="table border border-primary-content mb-5"
                                           :x-activity-id="activity.att_id"
                                           x-data="scenarioActivity">
                                        <tr>
                                            <th scope="row">
                                                <span x-text="index + 1"></span>:
                                                <span x-text="type"></span>
                                            </th>
                                            <td>
                                                <input type="text"
                                                       x-model="activity.att_description"
                                                       :disabled="editing_disabled"
                                                       placeholder="Description"
                                                       class="input input-sm input-ghost w-full modeler-input" />
                                            </td>
                                            <td class="text-right">
                                                <div class="tooltip tooltip-bottom"
                                                     data-tip="Insert activity before">
                                                    <button
                                                            @click="prepare_insert_before"
                                                            :index="index"
                                                            :disabled="editing_disabled"
                                                            class="btn btn-xs btn-outline btn-success">
                                                        <i class="fa-solid fa-angle-up"></i>
                                                    </button>
                                                </div>
                                                <div class="tooltip tooltip-bottom"
                                                     data-tip="Insert activity after">
                                                    <button
                                                            @click="prepare_insert_after"
                                                            :index="index"
                                                            :disabled="editing_disabled"
                                                            class="btn btn-xs btn-outline btn-success mr-5">
                                                        <i class="fa-solid fa-angle-down"></i>
                                                    </button>
                                                </div>

                                                <button @click="move_activity_up"
                                                        :index="index"
                                                        :disabled="editing_disabled"
                                                        x-show="index != 0" x-cloak x-transition
                                                        class="btn btn-xs btn-outline">
                                                    <i class="fa-solid fa-arrow-up"></i>
                                                </button>
                                                <button @click="move_activity_down"
                                                        :index="index"
                                                        :disabled="editing_disabled"
                                                        x-show="(model.activity.length - 1) > index" x-cloak x-transition
                                                        class="btn btn-xs btn-outline">
                                                    <i class="fa-solid fa-arrow-down"></i>
                                                </button>
                                                <button @click="remove_activity"
                                                        :id="activity.att_id"
                                                        :disabled="editing_disabled"
                                                        class="btn btn-xs btn-outline btn-error">
                                                    <i class="fa-regular fa-trash-can"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">

                                                <!-- set variables -->
                                                <template x-if="activity.att_type == 'set-variables'">
                                                    <table class="table table-xs mb-5">
                                                        <tr>
                                                            <th scope="col" colspan="4">Variables</th>
                                                        </tr>
                                                        <tr>
                                                            <th scope="col">Name</th>
                                                            <th scope="col">Type</th>
                                                            <th scope="col">Value</th>
                                                        </tr>
                                                        <template x-for="input in activity.input">
                                                            <tr>
                                                                <td>
                                                                    <input type="text"
                                                                           :disabled="editing_disabled"
                                                                           x-model="input.att_name"
                                                                           x-data="inputValidator"
                                                                           @input="camel_cased"
                                                                           placeholder="variableName"
                                                                           class="input input-xs w-full" />
                                                                </td>
                                                                <td>
                                                                    <select :disabled="editing_disabled"
                                                                            x-model="input.att_type"
                                                                            class="select select-xs select-ghost w-full modeler-input">
                                                                        <option>String</option>
                                                                        <option>Int</option>
                                                                        <option>Float</option>
                                                                        <option>Boolean</option>
                                                                        <option>Nested</option>
                                                                    </select>
                                                                </td>
                                                                <template x-if="input.att_type != 'Nested'">
                                                                    <td>
                                                                        <input type="text"
                                                                               x-model="input.att_value"
                                                                               :disabled="editing_disabled"
                                                                               placeholder="Description"
                                                                               class="input input-xs input-ghost w-full min-w-[15vw] modeler-input" />
                                                                    </td>
                                                                </template>
                                                                <template x-if="input.att_type == 'Nested'">
                                                                    <td x-data="scenarioActivityNestedInput">

                                                                        <template x-for="(item,index) in data" :key="index">
                                                                            <table class="table table-xs mb-5">
                                                                                <tr class="bg-primary-content">
                                                                                    <th scope="row" colspan="4">
                                                                                        Item <span x-text="index + 1"></span>
                                                                                    </th>
                                                                                </tr>
                                                                                <tr>
                                                                                    <th scope="col">Name</th>
                                                                                    <th scope="col">Type</th>
                                                                                    <th scope="col">Value</th>
                                                                                </tr>
                                                                                <template x-for="(value,key) in item" :key="key">
                                                                                    <tr x-data="{type: 'String'}" x-init="type = determine_type(value)">
                                                                                        <td x-text="key"></td>
                                                                                        <td>
                                                                                            <select x-model="type"
                                                                                                    @change="item[key] = convert_value(value,type)"
                                                                                                    class="select select-ghost select-xs w-full">
                                                                                                <option>String</option>
                                                                                                <option>Int</option>
                                                                                                <option>Float</option>
                                                                                                <option>Boolean</option>
                                                                                            </select>
                                                                                        </td>
                                                                                        <td>
                                                                                            <input type="text"
                                                                                                   :value="value"
                                                                                                   @change="item[key] = convert_value($el.value,type)"
                                                                                                   :disabled="editing_disabled"
                                                                                                   placeholder="Value"
                                                                                                   class="input input-xs input-ghost w-full modeler-input" />
                                                                                        </td>
                                                                                        <td>
                                                                                            <button @click="delete item[key]"
                                                                                                    :disabled="editing_disabled"
                                                                                                    class="btn btn-xs btn-outline btn-error">
                                                                                                <i class="fa-regular fa-trash-can"></i>
                                                                                            </button>
                                                                                        </td>
                                                                                    </tr>
                                                                                </template>
                                                                                <tr>
                                                                                    <td colspan="4">
                                                                                        <input type="text"
                                                                                               :disabled="editing_disabled"
                                                                                               x-data="inputValidator"
                                                                                               @input="camel_cased"
                                                                                               @focusout="insertField(item,$el.value)"
                                                                                               @keyup.enter="insertField(item,$el.value)"
                                                                                               placeholder="newFieldName"
                                                                                               class="input w-full input-xs" />
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </template>

                                                                        <button @click="if(data.length == 0){data.push({key: ''})}else{data.push(JSON.parse(JSON.stringify(data.at(-1))))}"
                                                                                :disabled="editing_disabled"
                                                                                class="btn btn-xs btn-outline btn-success">
                                                                            <i class="fa-regular fa-plus"></i> Add object
                                                                        </button>
                                                                    </td>
                                                                </template>
                                                                <td class="align-top">
                                                                    <button @click="activity.input = activity.input.filter(x => x.att_name != input.att_name)"
                                                                            :disabled="editing_disabled"
                                                                            class="btn btn-xs btn-outline btn-error">
                                                                        <i class="fa-regular fa-trash-can"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        <tr>
                                                            <td colspan="3"></td>
                                                            <td>
                                                                <button @click="add_input"
                                                                        :disabled="editing_disabled"
                                                                        class="btn btn-xs btn-outline btn-success">
                                                                    <i class="fa-solid fa-plus"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </template>

                                                <!-- Mutation -->
                                                <template x-if="activity.att_type == 'mutation'">
                                                    <div>

                                                        <!-- Command selector -->
                                                        <button class="btn btn-outline btn-primary btn-block mb-5"
                                                                @click="scs = activity.att_path.replace(/\.[^\.]*$/, '');select_command = true">
                                                            Command: <span x-text="activity.att_path"></span>
                                                        </button>
                                                        <dialog x-show="select_command" x-cloak x-transition class="modal modal-open">
                                                            <div class="modal-box">
                                                                <h3 class="text-lg font-bold">Select a command</h3>
                                                                <p class="py-4">
                                                                    <label class="input input-bordered flex items-center gap-2 my-5">
                                                                        <input type="text" class="grow" x-model="scs" placeholder="Search" />
                                                                        <svg
                                                                                xmlns="http://www.w3.org/2000/svg"
                                                                                viewBox="0 0 16 16"
                                                                                fill="currentColor"
                                                                                class="h-4 w-4 opacity-70">
                                                                            <path
                                                                                    fill-rule="evenodd"
                                                                                    d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                                                                                    clip-rule="evenodd" />
                                                                        </svg>
                                                                    </label>

                                                                    <table class="table">
                                                                        <template x-for="(path,file) in commands">
                                                                            <tr x-show="path.toLowerCase().includes(scs.toLowerCase()) || file.toLowerCase().includes(scs.toLowerCase())" x-cloak x-transition
                                                                                class="hover cursor-pointer"
                                                                                @click="change_command"
                                                                                :class="activity.att_path == path ? 'bg-primary-content' : ''">
                                                                                <td x-text="path"></td>
                                                                            </tr>
                                                                        </template>
                                                                    </table>
                                                                </p>
                                                                <div class="modal-action">
                                                                    <form method="dialog">
                                                                        <!-- if there is a button in form, it will close the modal -->
                                                                        <button class="btn" @click="select_command = false">Close</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </dialog>

                                                        <!-- Input -->
                                                        <table class="table table-xs mb-5">
                                                            <tr>
                                                                <th scope="col" colspan="4">Inputs</th>
                                                            </tr>
                                                            <tr>
                                                                <th scope="col">Name</th>
                                                                <th scope="col">Type</th>
                                                                <th scope="col">Value</th>
                                                            </tr>
                                                            <template x-for="input in activity.input">
                                                                <tr>
                                                                    <td x-text="input.att_name">
                                                                    </td>
                                                                    <td x-text="input.att_type">
                                                                    </td>
                                                                    <template x-if="input.att_value.startsWith('#')">
                                                                        <td>
                                                                            <select x-model="input.att_value" class="select select-ghost select-xs w-full">
                                                                                <option value="#">-select-flow-variable-</option>
                                                                                <template x-for="flowvar in flowvars" :key="flowvar">
                                                                                    <option :value="flowvar"
                                                                                            x-text="flowvar.replaceAll('#','')"
                                                                                            :selected="flowvar == input.att_value"></option>
                                                                                </template>
                                                                                <option>-inline-</option>
                                                                            </select>
                                                                        </td>
                                                                    </template>
                                                                    <template x-if="!input.att_value.startsWith('#') && input.att_type != 'Nested'">
                                                                        <td>
                                                                            <input type="text"
                                                                                   x-model="input.att_value"
                                                                                   :disabled="editing_disabled"
                                                                                   placeholder="Description"
                                                                                   class="input input-xs input-ghost w-full min-w-[15vw] modeler-input" />
                                                                        </td>
                                                                    </template>
                                                                    <template x-if="!input.att_value.startsWith('#') && input.att_type == 'Nested'">
                                                                        <td x-data="scenarioActivityNestedInput">

                                                                            <template x-for="(item,index) in data" :key="index">
                                                                                <table class="table table-xs mb-5">
                                                                                    <tr class="bg-primary-content">
                                                                                        <th scope="row" colspan="2">
                                                                                            Item <span x-text="index + 1"></span>
                                                                                        </th>
                                                                                        <td class="text-right">
                                                                                            <button @click="data.splice(index,1)"
                                                                                                    :disabled="editing_disabled"
                                                                                                    class="btn btn-xs btn-outline btn-error">
                                                                                                <i class="fa-regular fa-trash-can"></i>
                                                                                            </button>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <tr>
                                                                                        <th scope="col">Name</th>
                                                                                        <th scope="col">Value</th>
                                                                                    </tr>
                                                                                    <template x-for="(value,key) in item" :key="key">
                                                                                        <tr x-data="{type: 'String'}" x-init="type = determine_type(value)">
                                                                                            <td x-text="key"></td>
                                                                                            <template x-if="!value.startsWith('#')">
                                                                                                <td>
                                                                                                    <input type="text"
                                                                                                           :value="value"
                                                                                                           @change="item[key] = convert_value($el.value,type)"
                                                                                                           :disabled="editing_disabled"
                                                                                                           placeholder="Value"
                                                                                                           class="input input-xs input-ghost w-full modeler-input" />
                                                                                                </td>
                                                                                            </template>
                                                                                            <template x-if="value.startsWith('#')">
                                                                                                <td>
                                                                                                    <select @change="item[key] = convert_value($el.value,type)"
                                                                                                            class="select select-ghost select-xs w-full">
                                                                                                        <option value="#">-select-flow-variable-</option>
                                                                                                        <template x-for="flowvar in flowvars" :key="flowvar">
                                                                                                            <option :value="flowvar"
                                                                                                                    x-text="flowvar.replaceAll('#','')"
                                                                                                                    :selected="flowvar == value"></option>
                                                                                                        </template>
                                                                                                        <option>-inline-</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                            </template>
                                                                                        </tr>
                                                                                    </template>
                                                                                </table>
                                                                            </template>

                                                                            <button @click="add_object"
                                                                                    :disabled="editing_disabled"
                                                                                    class="btn btn-xs btn-outline btn-success">
                                                                                <i class="fa-regular fa-plus"></i> Add object
                                                                            </button>
                                                                        </td>
                                                                    </template>
                                                                </tr>
                                                            </template>
                                                        </table>

                                                        <!-- Traces -->
                                                        <table class="table table-xs mb-5">
                                                            <tr>
                                                                <th scope="col" colspan="4">Expected invocations</th>
                                                            </tr>
                                                            <template x-for="(trace,index) in activity['expected-trace']">
                                                                <tr>
                                                                    <th scope="row" x-text="trace.att_command.endsWith('-Notifier') ? 'Notifier' : 'Behavior'"></th>
                                                                    <td>
                                                                        <select x-model="trace.att_command" class="select select-ghost select-xs w-full">
                                                                            <template x-for="component in components" :key="component">
                                                                                <option :value="component"
                                                                                        x-text="component"
                                                                                        :selected="component == trace.att_command"></option>
                                                                            </template>
                                                                        </select>
                                                                    </td>
                                                                    <td>
                                                                        <select x-model="trace.att_status" class="select select-ghost select-xs w-full">
                                                                            <option>success</option>
                                                                            <option>error</option>
                                                                        </select>
                                                                    </td>
                                                                    <td class="text-right">
                                                                        <button @click="activity['expected-trace'].splice(index,1)"
                                                                                :disabled="editing_disabled"
                                                                                class="btn btn-xs btn-outline btn-error">
                                                                            <i class="fa-regular fa-trash-can"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </template>
                                                            <tr>
                                                                <td colspan="3"></td>
                                                                <td class="text-right">
                                                                    <button @click="activity['expected-trace'].push({att_command: components.at(0), att_status: 'success'})"
                                                                            :disabled="editing_disabled"
                                                                            class="btn btn-xs btn-outline btn-success">
                                                                        <i class="fa-solid fa-plus"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </template>

                                                <!-- Switch user -->
                                                <template x-if="activity.att_type == 'switch-user'">
                                                    <table class="table table-xs mb-5">
                                                        <tr>
                                                            <th scope="row">User number</th>
                                                            <td>
                                                                <input type="number"
                                                                       min="1"
                                                                       max="100"
                                                                       x-model="activity['att_user-number']"
                                                                       class="input input-ghost w-full input-xs modeler-input" />
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </template>

                                                <!-- Wait -->
                                                <template x-if="activity.att_type == 'wait'">
                                                    <table class="table table-xs mb-5">
                                                        <tr>
                                                            <th scope="row">Wait for</th>
                                                            <td>
                                                                <input type="number"
                                                                       x-model="activity.att_milliseconds"
                                                                       class="input input-ghost w-full input-xs modeler-input" />
                                                            </td>
                                                            <td>Milliseconds</td>
                                                        </tr>
                                                    </table>
                                                </template>

                                                <!-- Grant role -->
                                                <template x-if="activity.att_type == 'grant-role'">
                                                    <table class="table table-xs mb-5">
                                                        <tr>
                                                            <th scope="row">Role</th>
                                                            <td x-data="metaContainer">
                                                                <select x-model="activity.att_role" class="select select-ghost select-xs w-full">
                                                                    <option></option>
                                                                    <template x-for="role  in model.roles">
                                                                        <option :value="role" x-text="role" :selected="role == activity.att_role"></option>
                                                                    </template>
                                                                </select>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </template>

                                                <!-- Query -->
                                                <template x-if="activity.att_type == 'query'">
                                                    <div>

                                                        <!-- Query selector -->
                                                        <button class="btn btn-outline btn-primary btn-block mb-5"
                                                                @click="sqs = activity.att_path.replace(/\.[^\.]*$/, '');select_query = true">
                                                            Query: <span x-text="activity.att_path"></span>
                                                        </button>
                                                        <dialog x-show="select_query" x-cloak x-transition class="modal modal-open">
                                                            <div class="modal-box">
                                                                <h3 class="text-lg font-bold">Select a query</h3>
                                                                <p class="py-4">
                                                                    <label class="input input-bordered flex items-center gap-2 my-5">
                                                                        <input type="text" class="grow" x-model="sqs" placeholder="Search" />
                                                                        <svg
                                                                                xmlns="http://www.w3.org/2000/svg"
                                                                                viewBox="0 0 16 16"
                                                                                fill="currentColor"
                                                                                class="h-4 w-4 opacity-70">
                                                                            <path
                                                                                    fill-rule="evenodd"
                                                                                    d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                                                                                    clip-rule="evenodd" />
                                                                        </svg>
                                                                    </label>

                                                                <table class="table">
                                                                    <template x-for="query in Object.keys(queries)">
                                                                        <tr x-show="query.toLowerCase().includes(sqs.toLowerCase())" x-cloak x-transition
                                                                            class="hover cursor-pointer"
                                                                            @click="change_query"
                                                                            :class="activity.att_path == query ? 'bg-primary-content' : ''">
                                                                            <td x-text="query"></td>
                                                                        </tr>
                                                                    </template>
                                                                </table>
                                                                </p>
                                                                <div class="modal-action">
                                                                    <form method="dialog">
                                                                        <!-- if there is a button in form, it will close the modal -->
                                                                        <button class="btn" @click="select_query = false">Close</button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </dialog>

                                                        <!-- Input -->
                                                        <table class="table table-xs mb-5">
                                                            <tr>
                                                                <th scope="col" colspan="4">Query parameters</th>
                                                            </tr>
                                                            <tr>
                                                                <th scope="col">Name</th>
                                                                <th scope="col">Type</th>
                                                                <th scope="col">Value</th>
                                                            </tr>
                                                            <template x-for="input in activity.input" :key="input.att_id">
                                                                <tr>
                                                                    <td x-text="input.att_name">
                                                                    </td>
                                                                    <td x-text="input.att_type">
                                                                    </td>
                                                                    <template x-if="input.att_value.startsWith('#')">
                                                                        <td>
                                                                            <select x-model="input.att_value" class="select select-ghost select-xs w-full">
                                                                                <option value="#">-select-flow-variable-</option>
                                                                                <template x-for="flowvar in flowvars" :key="flowvar">
                                                                                    <option :value="flowvar"
                                                                                            x-text="flowvar.replaceAll('#','')"
                                                                                            :selected="flowvar == input.att_value"></option>
                                                                                </template>
                                                                                <option>-inline-</option>
                                                                            </select>
                                                                        </td>
                                                                    </template>
                                                                    <template x-if="!input.att_value.startsWith('#')">
                                                                        <td>
                                                                            <input type="text"
                                                                                   x-model="input.att_value"
                                                                                   :disabled="editing_disabled"
                                                                                   placeholder="Description"
                                                                                   class="input input-xs input-ghost w-full min-w-[15vw] modeler-input" />
                                                                        </td>
                                                                    </template>
                                                                </tr>
                                                            </template>
                                                        </table>

                                                        <!-- Expected values -->
                                                        <table class="table table-xs mb-5">
                                                            <tr>
                                                                <th scope="col" colspan="4">Expected Values</th>
                                                            </tr>
                                                            <tr>
                                                                <th scope="col">Path</th>
                                                                <th scope="col">Type</th>
                                                                <th scope="col">Expected value</th>
                                                            </tr>
                                                            <template x-if="queries_ready">
                                                                <template x-for="expected in activity['expect-value']" :key="expected.att_id">
                                                                    <tr>
                                                                        <td x-data="viewPathBuilder">
                                                                            <template x-for="(p,index) in path">
                                                                                <span x-data="{editing: false}">
                                                                                    <span x-show="index != 0" x-cloak x-transition> &middot; </span>
                                                                                    <span class="modeler-input cursor-pointer"
                                                                                          x-show="!editing" x-cloak x-transition
                                                                                          @click="editing = true"
                                                                                          x-text="p"></span>
                                                                                    <select :disabled="editing_disabled"
                                                                                            x-model="path[index]"
                                                                                            x-show="editing" x-cloak x-transition
                                                                                            @blur="editing = false"
                                                                                            @change="update_path"
                                                                                            class="select select-ghost select-xs modeler-input">
                                                                                        <template x-for="option in options[index]">
                                                                                            <option :value="option" x-text="option" :selected="option == p"></option>
                                                                                        </template>
                                                                                    </select>
                                                                                </span>
                                                                            </template>
                                                                            <div hidden="true" x-text="JSON.stringify(options,null,2)"></div>
                                                                        </td>
                                                                        <td x-text="expected.att_type">
                                                                        </td>
                                                                        <template x-if="expected.att_value.startsWith('#')">
                                                                            <td>
                                                                                <select x-model="expected.att_value" class="select select-ghost select-xs w-full">
                                                                                    <option value="#">-select-flow-variable-</option>
                                                                                    <template x-for="flowvar in flowvars" :key="flowvar">
                                                                                        <option :value="flowvar"
                                                                                                x-text="flowvar.replaceAll('#','')"
                                                                                                :selected="flowvar == expected.att_value"></option>
                                                                                    </template>
                                                                                    <option>-inline-</option>
                                                                                </select>
                                                                            </td>
                                                                        </template>
                                                                        <template x-if="!expected.att_value.startsWith('#')">
                                                                            <td>
                                                                                <input type="text"
                                                                                       x-model="expected.att_value"
                                                                                       :disabled="editing_disabled"
                                                                                       placeholder="Description"
                                                                                       class="input input-xs input-ghost w-full modeler-input" />
                                                                            </td>
                                                                        </template>
                                                                        <td class="text-right">
                                                                            <button @click="activity['expect-value'] = activity['expect-value'].filter(x => x.att_id != expected.att_id)" class="btn btn-xs btn-outline btn-error">
                                                                                <i class="fa-regular fa-trash-can"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                </template>
                                                            </template>
                                                            <tr>
                                                                <td colspan="3"></td>
                                                                <td class="text-right">
                                                                    <button @click="add_expected_value" class="btn btn-xs btn-outline btn-success">
                                                                        <i class="fa-solid fa-plus"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </table>

                                                        <!-- Extract values -->
                                                        <table class="table table-xs mb-5">
                                                            <tr>
                                                                <th scope="col" colspan="4">Data Extractions</th>
                                                            </tr>
                                                            <tr>
                                                                <th scope="col">Name</th>
                                                                <th scope="col">Type</th>
                                                                <th scope="col">Path</th>
                                                            </tr>
                                                            <template x-if="queries_ready">
                                                                <template x-for="expected in activity['extract-value']" :key="expected.att_id">
                                                                    <tr>
                                                                        <td x-text="expected['att_put-key']"></td>
                                                                        <td x-text="expected.att_type"></td>
                                                                        <td x-data="viewPathBuilder">
                                                                            <template x-for="(p,index) in path">
                                                                                <span x-data="{editing: false}">
                                                                                    <span x-show="index != 0" x-cloak x-transition> &middot; </span>
                                                                                    <span class="modeler-input cursor-pointer"
                                                                                          x-show="!editing" x-cloak x-transition
                                                                                          @click="editing = true"
                                                                                          x-text="p"></span>
                                                                                    <select :disabled="editing_disabled"
                                                                                            x-model="path[index]"
                                                                                            x-show="editing" x-cloak x-transition
                                                                                            @blur="editing = false"
                                                                                            @change="update_path"
                                                                                            class="select select-ghost select-xs modeler-input">
                                                                                        <template x-for="option in options[index]">
                                                                                            <option :value="option" x-text="option" :selected="option == p"></option>
                                                                                        </template>
                                                                                    </select>
                                                                                </span>
                                                                            </template>
                                                                            <div hidden="true" x-text="JSON.stringify(options,null,2)"></div>
                                                                        </td>
                                                                        <td class="text-right">
                                                                            <button @click="activity['extract-value'] = activity['extract-value'].filter(x => x.att_id != expected.att_id)" class="btn btn-xs btn-outline btn-error">
                                                                                <i class="fa-regular fa-trash-can"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                </template>
                                                            </template>
                                                            <tr>
                                                                <td colspan="3"></td>
                                                                <td class="text-right">
                                                                    <button @click="add_extraction" class="btn btn-xs btn-outline btn-success">
                                                                        <i class="fa-solid fa-plus"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </template>

                                            </td>
                                        </tr>
                                    </table>
                                </template>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="col-span-4">

                    <!-- Info Card -->
                    <div class="card bg-primary text-primary-content mb-5 card-compact" x-data="infoCard">
                        <div class="card-body">
                            <div class="card-actions justify-end">
                                <i @click="Draftsman.publishMessage('focus')"
                                   class="fa-regular fa-eye cursor-pointer"></i>
                                <i @click="open_github"
                                   :file="navigation"
                                   class="fa-solid fa-code cursor-pointer"></i>
                                <i @click="open_docs"
                                   slug="Modeling-Concepts/Utils/Scenario"
                                   class="fa-solid fa-question cursor-pointer"></i>
                            </div>
                            <h2 class="card-title">Functional Test Scenario</h2>
                            <p class="text-xs" :file="navigation" x-text="get_path"></p>

                            <table class="table table-xs">
                                <tr>
                                    <th  scope="row">Scenario name</th>
                                    <td>
                                        <input type="text"
                                               :disabled="editing_disabled"
                                               x-model="newName"
                                               x-data="inputValidator"
                                               @input="pascal_cased"
                                               @keyup.debounce.500ms="check_name"
                                               placeholder="ScenarioName"
                                               class="input input-ghost w-[70%] input-xs mr-2" />
                                        <button x-show="newName != model.att_name" x-cloak x-transition
                                                @click="rename"
                                                class="btn btn-outline btn-xs"
                                                :class="duplicateName ? 'btn-error' : 'btn-success'">
                                            save
                                        </button>
                                    </td>
                                </tr>
                            </table>
                            <table class="table table-xs my-3">
                                <tr>
                                    <th scope="col" colspan="2">
                                        Depends on
                                    </th>
                                </tr>
                                <template x-for="reference in model.att_extends.split(';').filter(x => x)" :key="reference">
                                    <tr>
                                        <td x-text="reference"></td>
                                        <td x-show="editing_enabled" x-cloak x-transition class="text-right">
                                            <i class="fa-regular fa-trash-can cursor-pointer"
                                               @click="model.att_extends = model.att_extends.split(';').filter(x => x != reference).join(';')"></i>
                                        </td>
                                    </tr>
                                </template>
                                <tr>
                                    <td colspan="2">
                                        <select @change="add_dependency" class="select select-ghost select-xs w-full">
                                            <option value="">Add dependency</option>
                                            <template x-for="reference in scenarios" :key="reference">
                                                <option :value="reference" x-text="reference"></option>
                                            </template>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                            <div class="card-actions justify-end"
                                 x-show="editing_enabled" x-cloak x-transition>
                                <i class="fa-regular fa-trash-can cursor-pointer" @click="delete_model"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Diagram -->
                    <div x-import="elements/embedded-diagram">
                        <ui-gate-diagram></ui-gate-diagram>
                    </div>

                    <!-- documentation -->
                    <div :file="navigation" x-data="markdownEditor"></div>

                </div>
            </div>
        </div>
    </div>
</template>