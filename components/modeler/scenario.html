<template x-component="scenario">
    <div navigation-type="scenario"
         id="active-tab"
         x-show="navigationElementActive"
         x-cloak
         x-transition>
        <div :file="navigation" x-data="scenarioModel">
            <div class="grid grid-cols-12 gap-3 mt-5">
                <div class="col-span-8">

                    <h3 class="text-2xl font-semibold text-gray-800 mb-5">
                        Scenario: <span x-text="path"></span>
                    </h3>
                    <div class="grid grid-cols-12 gap-3 mt-5">
                        <div class="col-span-3 scrollbar-v scrollbar-v-left border-r pr-2 h-[70vh]">
                            <ul class="menu menu-xs rounded-lg scroll-v-inside scrollbar-h mb-5">
                                <template x-for="(activity,index) in model.activity" :key="activity.att_id">
                                    <li x-data="scenarioActivity">
                                        <a @click="scrollToTable(activity.att_id)"
                                           :class="active == activity.att_id ? 'active' : ''">
                                            <i class="fa-solid fa-play"></i>
                                            <p>
                                                <span x-text="type"></span><br>
                                                <span x-text="activity.att_description"></span>
                                            </p>
                                        </a>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <div class="col-span-9 scrollbar-v h-[70vh]" @scroll="onScroll">
                            <div x-init="onScroll">
                                <template x-for="(activity,index) in model.activity" :key="activity.att_id">
                                    <table class="table border border-primary-content mb-5"
                                           :x-activity-id="activity.att_id"
                                           x-data="scenarioActivity">
                                        <tr>
                                            <th scope="row">
                                                <span x-text="index + 1"></span>:
                                                <span x-text="type"></span>
                                            </th>
                                            <td>
                                                <input type="text"
                                                       x-model="activity.att_description"
                                                       :disabled="editing_disabled"
                                                       placeholder="Description"
                                                       class="input input-sm input-ghost w-full modeler-input" />
                                            </td>
                                            <td class="text-right">
                                                <div class="tooltip tooltip-bottom"
                                                     data-tip="Insert activity before">
                                                    <button
                                                            @click="prepare_insert_before"
                                                            :index="index"
                                                            :disabled="editing_disabled"
                                                            class="btn btn-xs btn-outline btn-success">
                                                        <i class="fa-solid fa-angle-up"></i>
                                                    </button>
                                                </div>
                                                <div class="tooltip tooltip-bottom"
                                                     data-tip="Insert activity after">
                                                    <button
                                                            @click="prepare_insert_after"
                                                            :index="index"
                                                            :disabled="editing_disabled"
                                                            class="btn btn-xs btn-outline btn-success mr-5">
                                                        <i class="fa-solid fa-angle-down"></i>
                                                    </button>
                                                </div>

                                                <button @click="move_activity_up"
                                                        :index="index"
                                                        :disabled="editing_disabled"
                                                        x-show="index != 0" x-cloak x-transition
                                                        class="btn btn-xs btn-outline">
                                                    <i class="fa-solid fa-arrow-up"></i>
                                                </button>
                                                <button @click="move_activity_down"
                                                        :index="index"
                                                        :disabled="editing_disabled"
                                                        x-show="(model.activity.length - 1) > index" x-cloak x-transition
                                                        class="btn btn-xs btn-outline">
                                                    <i class="fa-solid fa-arrow-down"></i>
                                                </button>
                                                <button @click="remove_activity"
                                                        :id="activity.att_id"
                                                        :disabled="editing_disabled"
                                                        class="btn btn-xs btn-outline btn-error">
                                                    <i class="fa-regular fa-trash-can"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                <template x-if="activity.att_type == 'set-variables'">
                                                    <table class="table table-xs mb-5">
                                                        <tr>
                                                            <th scope="col" colspan="4">Variables</th>
                                                        </tr>
                                                        <tr>
                                                            <th scope="col">Name</th>
                                                            <th scope="col">Type</th>
                                                            <th scope="col">Value</th>
                                                        </tr>
                                                        <template x-for="input in activity.input">
                                                            <tr>
                                                                <td>
                                                                    <input type="text"
                                                                           :disabled="editing_disabled"
                                                                           x-model="input.att_name"
                                                                           x-data="inputValidator"
                                                                           @input="camel_cased"
                                                                           placeholder="variableName"
                                                                           class="input w-full" />
                                                                </td>
                                                                <td>
                                                                    <select :disabled="editing_disabled"
                                                                            x-model="input.att_type"
                                                                            class="select select-ghost w-full modeler-input">
                                                                        <option>String</option>
                                                                        <option>Int</option>
                                                                        <option>Float</option>
                                                                        <option>Boolean</option>
                                                                        <option>Nested</option>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                           x-model="input.att_value"
                                                                           :disabled="editing_disabled"
                                                                           placeholder="Description"
                                                                           class="input input-sm input-ghost w-full min-w-[15vw] modeler-input" />
                                                                </td>
                                                                <td>
                                                                    <button @click="activity.input = activity.input.filter(x => x.att_name != input.att_name)"
                                                                            :disabled="editing_disabled"
                                                                            class="btn btn-xs btn-outline btn-error">
                                                                        <i class="fa-regular fa-trash-can"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                        <tr>
                                                            <td colspan="3"></td>
                                                            <td>
                                                                <button @click="add_input"
                                                                        :disabled="editing_disabled"
                                                                        class="btn btn-xs btn-outline btn-success">
                                                                    <i class="fa-solid fa-plus"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </template>

                                                <pre x-text="JSON.stringify(activity,null,2)"></pre>
                                            </td>
                                        </tr>
                                    </table>
                                </template>
                            </div>
                        </div>
                    </div>

                    <dialog x-show="insertActivityModal" x-cloak x-transition
                            class="modal modal-open">
                        <div class="modal-box w-11/12 max-w-5xl">
                            <form method="dialog">
                                <button @click="insertActivityModal = false" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                            </form>
                            <h3 class="font-bold text-lg">Add activity</h3>

                            <label class="input input-bordered flex items-center gap-2 mt-5">
                                <input type="text" class="grow" x-model="search" placeholder="Search" />
                                <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 16 16"
                                        fill="currentColor"
                                        class="h-4 w-4 opacity-70">
                                    <path
                                            fill-rule="evenodd"
                                            d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z"
                                            clip-rule="evenodd" />
                                </svg>
                            </label>

                            <table class="table mt-2" x-data="{types: []}" x-effect="if(insertActivityModal){types = get_types()}">
                                <template x-if="types.length != 0">
                                    <template x-for="type in activity_types" :key="type">
                                        <tr @click="insert"
                                            :activity-type="type"
                                            :index="index"
                                            class="hover"
                                            x-show="type.includes(search.toLowerCase())" x-cloak x-transition>
                                            <th x-text="type"></th>
                                            <td class="text-right">
                                                <i class="fa-solid fa-plus"></i>
                                            </td>
                                        </tr>
                                    </template>
                                </template>

                            </table>
                        </div>
                    </dialog>

                </div>
                <div class="col-span-4">

                    <!-- Info Card -->
                    <div class="card bg-primary text-primary-content mb-5 card-compact" x-data="infoCard">
                        <div class="card-body">
                            <div class="card-actions justify-end">
                                <i @click="Draftsman.publishMessage('focus')"
                                   class="fa-regular fa-eye cursor-pointer"></i>
                                <i @click="open_github"
                                   :file="navigation"
                                   class="fa-solid fa-code cursor-pointer"></i>
                            </div>
                            <h2 class="card-title">Functional Test Scenario</h2>
                            <p class="text-xs" :file="navigation" x-text="get_path"></p>

                            <table class="table table-xs">
                                <tr>
                                    <th  scope="row">Scenario name</th>
                                    <td>
                                        <input type="text"
                                               :disabled="editing_disabled"
                                               x-model="newName"
                                               x-data="inputValidator"
                                               @input="pascal_cased"
                                               @keyup.debounce.500ms="check_name"
                                               placeholder="ScenarioName"
                                               class="input input-ghost w-[70%] input-xs mr-2" />
                                        <button x-show="newName != model.att_name" x-cloak x-transition
                                                @click="rename"
                                                class="btn btn-outline btn-xs"
                                                :class="duplicateName ? 'btn-error' : 'btn-success'">
                                            save
                                        </button>
                                    </td>
                                </tr>
                            </table>
                            <table class="table table-xs my-3">
                                <tr>
                                    <th scope="col" colspan="2">
                                        Depends on
                                    </th>
                                </tr>
                                <template x-for="reference in model.att_extends.split(';')" :key="reference">
                                    <tr>
                                        <td x-text="reference"></td>
                                        <td x-show="editing_enabled" x-cloak x-transition class="text-right">
                                            <i class="fa-regular fa-trash-can cursor-pointer"
                                               @click="model.att_extends = model.att_extends.split(';').filter(x => x != reference).join(';')"></i>
                                        </td>
                                    </tr>
                                </template>
                                <tr>
                                    <td colspan="2">
                                        <select @change="add_dependency" class="select select-ghost select-xs w-full">
                                            <option value="">Add dependency</option>
                                            <template x-for="reference in scenarios" :key="reference">
                                                <option :value="reference" x-text="reference"></option>
                                            </template>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                            <div class="card-actions justify-end"
                                 x-show="editing_enabled" x-cloak x-transition>
                                <i class="fa-regular fa-trash-can cursor-pointer" @click="delete_model"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Diagram -->
<!--                    <div x-import="elements/embedded-diagram">-->
<!--                        <ui-embedded-diagram></ui-embedded-diagram>-->
<!--                    </div>-->

                    <!-- documentation -->
                    <div :file="navigation" x-data="markdownEditor"></div>

                </div>
            </div>
        </div>
    </div>
</template>